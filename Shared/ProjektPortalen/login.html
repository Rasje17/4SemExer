<!DOCTYPE html>
<html>

<head>
    <title>ProjektPortalen</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        const urlParams = new URLSearchParams(window.location.search);

        function loginHandle(JSONdata) {
            console.log(JSONdata);
            let data = JSONdata.id;
            let return_url = "";

            if (urlParams.has('src')) {


                return_url = urlParams.get('src');


                window.location.href = return_url;
            }

            else {
                if (data === true) {
                    // business sendes til businesspage
                    window.location.href = ('businessPage.html');
                }
                else {
                    // student sendes til offer overview
                    window.location.href = ('offerOverview.html?');
                }



            }
        }

        window.onload = () => {
            let loginBtn = document.getElementById("loginButton");
            loginBtn.addEventListener("click", () => {
                let userName = document.getElementById("uNameField").value;
                let pw = document.getElementById("pwField").value;

                // // xhr method
                // var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
                // var theUrl = "/json-handler";
                // xmlhttp.open("POST", "http://localhost:8888/loginuser", true);
                // xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                // xmlhttp.withCredentials = true;
                // xmlhttp.send(JSON.stringify({
                //     username: userName,
                //     password: pw // should be hashed
                // }));

                //fetch method
                fetch("http://localhost:8888/loginuser", {
                    method: 'POST',
                    body: JSON.stringify({
                        username: userName,
                        password: pw // should be hashed
                    }),
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    },
                    credentials: "include",
                })
                    .then(response => {
                        //sucsess
                        if (response.status === 200) {
                            response.json()
                                .then(json => loginHandle(json))
                        }
                        // wrong pw
                        else if (response.status === 401) {
                            document.getElementById('warningLabel').innerHTML = 'Wrong Password';
                            console.log('got a 401 wrong pw')
                        }
                        // user dos not exist
                        else if (response.status === 404) {
                            document.getElementById('warningLabel').innerHTML = 'Wrong User Name';
                            console.log('got a 404 wrong user')
                        }
                        //not enough data
                        else if (response.status === 422) {
                            document.getElementById('warningLabel').innerHTML = 'Enter both username and password';
                            console.log('got a 422 wrong data')
                        }
                    })
            });

            document.getElementById("createNewButton").onclick = function () {
                location.href = 'createUser.html';
            };
        }
    </script>
</head>

<header>
    <a href="index.html">Forside</a>
</header>

<body>
    <h1>Login</h1>

    <div>
        Brugernavn: <input class="loginBox" id="uNameField" type="text" name="username"><br>
        Password: <input class="loginBox" id="pwField" type="password" name="pw"><br>
        <input class="loginBox" id="loginButton" type="submit" value="Log ind">
        <input class="loginBox" id="createNewButton" type="button" value="Opret nyt login">
        <p id='warningLabel' value='' style="color:red"></p>
    </div>
</body>

</html>